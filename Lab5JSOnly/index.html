<html>
  <head>
  </head>
  <body>
    <script type="application/javascript">
      const getMessages = async () => {
        const response = await fetch('https://chat.calicheoficial.lat/messages');
        return await response.json();
    };
    
    const postMessage = async (message) => {
        const response = await fetch('https://chat.calicheoficial.lat/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(message)
        });
        return await response.json();
    };
    
    const createMessageElement = (message) => {
        const li = document.createElement('li');
        li.style.padding = '10px';
        li.style.borderBottom = '1px solid #ddd';
        li.style.animation = 'fadeIn 0.5s';
    
        const user = document.createElement('strong');
        user.append(`${message.user}: `);
    
        const text = document.createElement('span');
        text.innerHTML = detectLinks(message.text);
    
        li.append(user, text);
        return li;
    };
    
    // Función para detectar enlaces y mostrar previsualizaciones
    const detectLinks = (text) => {
        const imageRegex = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/gi;
        const urlRegex = /(https?:\/\/[^\s]+)/gi;
    
        if (text.match(imageRegex)) {
            return text.replace(imageRegex, `<br><img src="$1" style="max-width:200px; display:block;">`);
        }
        
        return text.replace(urlRegex, `<a href="$1" target="_blank">$1</a>`);
    };
    
    const drawMessages = async () => {
        const container = document.getElementById('messages-container') || document.createElement('div');
        container.id = 'messages-container';
        container.style.height = '70vh';
        container.style.overflowY = 'auto';
        container.innerHTML = '';
    
        const ul = document.createElement('ul');
        ul.style.listStyle = 'none';
        ul.style.padding = '0';
    
        const messages = await getMessages();
        messages.forEach((message) => ul.appendChild(createMessageElement(message)));
    
        container.appendChild(ul);
        document.body.appendChild(container);
        container.scrollTop = container.scrollHeight; // Mantener scroll abajo
    };
    
    const drawInput = () => {
        const container = document.getElementById('input-container') || document.createElement('div');
        container.id = 'input-container';
        container.style.position = 'fixed';
        container.style.bottom = '0';
        container.style.width = '100%';
        container.style.background = 'white';
        container.style.padding = '10px';
        container.style.display = 'flex';
        container.style.borderTop = '1px solid #ccc';
    
        const textarea = document.createElement('input');
        textarea.type = 'text';
        textarea.placeholder = 'Escribe un mensaje...(140 palabras)';
        textarea.style.flex = '1';
        textarea.style.padding = '10px';
        textarea.style.border = '1px solid #ccc';
        textarea.style.borderRadius = '5px';
        textarea.maxLength = 140; // Límite de caracteres
    
        const button = document.createElement('button');
        button.append('SEND');
        button.style.marginLeft = '10px';
        button.style.padding = '10px';
    
        button.onclick = async () => {
            if (textarea.value.trim()) {
                await postMessage({ text: textarea.value, user: 'miausUwu' });
                textarea.value = '';
                await drawMessages();
            }
        };
    
        textarea.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                button.click();
            }
        });
    
        container.innerHTML = '';
        container.append(textarea, button);
        document.body.appendChild(container);
    };
    
    // Alternar modo claro/oscuro
    const toggleTheme = () => {
        const currentTheme = localStorage.getItem('theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.body.style.background = newTheme === 'dark' ? '#222' : '#fff';
        document.body.style.color = newTheme === 'dark' ? '#fff' : '#000';
        localStorage.setItem('theme', newTheme);
    };
    
    // Agregar botón de tema
    const drawThemeButton = () => {
        const button = document.createElement('button');
        button.innerText = '🌙/☀️';
        button.style.position = 'fixed';
        button.style.top = '10px';
        button.style.right = '10px';
        button.style.padding = '5px';
        button.onclick = toggleTheme;
    
        document.body.appendChild(button);
        toggleTheme();
    };
    
    const main = async () => {
        await drawMessages();
        drawInput();
        drawThemeButton();
        setInterval(drawMessages, 5000); // Auto-refresh cada 5 segundos
    };
    
    main();
    
    </script>
  </body>
</html>